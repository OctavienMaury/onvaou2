<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>On va où ?</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html,body,#root{height:100%;margin:0}
.map{height:100%;width:100%}
.custom-marker{background:none;border:none}
</style>
</head>

<body>
<div id="root"></div>

<script>
const {useState,useEffect,useRef,useCallback} = React;

const API_PROXY_URL='https://soft-cake-00a9.kmdf29dr47.workers.dev';
const OVERPASS_API='https://overpass-api.de/api/interpreter';

const MAIN_STATIONS=[
 {name:'Paris Gare de Lyon',lat:48.8443,lon:2.3744},
 {name:'Lyon Part-Dieu',lat:45.7606,lon:4.8590},
 {name:'Marseille Saint-Charles',lat:43.3026,lon:5.3797}
];

function OptimizedMap({center,zoom,markers,polyline}) {
  const mapRef = useRef(null);
  const mapInstance = useRef(null);
  const markersLayer = useRef(L.layerGroup());
  const polylineLayer = useRef(L.layerGroup());

  // INIT MAP (once)
  useEffect(()=>{
    mapInstance.current = L.map(mapRef.current,{center,zoom});
    L.tileLayer(
      'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
      {maxZoom:19}
    ).addTo(mapInstance.current);

    markersLayer.current.addTo(mapInstance.current);
    polylineLayer.current.addTo(mapInstance.current);

    return ()=>mapInstance.current.remove();
  },[]);

  // UPDATE MARKERS
  useEffect(()=>{
    markersLayer.current.clearLayers();
    const bounds=[];

    markers.forEach(m=>{
      if(Number.isFinite(m.lat)&&Number.isFinite(m.lng)){
        const icon=L.divIcon({
          className:'custom-marker',
          html:`<div style="
            width:18px;height:18px;
            background:${m.color};
            border-radius:50%;
            border:3px solid white"></div>`
        });

        L.marker([m.lat,m.lng],{icon})
          .bindTooltip(m.label)
          .addTo(markersLayer.current);

        bounds.push([m.lat,m.lng]);
      }
    });

    if(bounds.length>1){
      mapInstance.current.fitBounds(bounds,{padding:[40,40]});
    } else if(bounds.length===1){
      mapInstance.current.setView(bounds[0],zoom);
    }
  },[markers]);

  // UPDATE POLYLINE
  useEffect(()=>{
    polylineLayer.current.clearLayers();
    if(polyline?.length>=2){
      L.polyline(polyline,{
        color:'#00d4aa',
        weight:3,
        dashArray:'8,6'
      }).addTo(polylineLayer.current);
    }
  },[polyline]);

  return <div ref={mapRef} className="map"></div>;
}

function App(){
  const [journey,setJourney]=useState(null);
  const [places,setPlaces]=useState([]);

  const fetchPlaces = async(lat,lon)=>{
    const query=`[out:json];
      node["tourism"="museum"](around:2000,${lat},${lon});
      node["historic"="castle"](around:2000,${lat},${lon});
      node["historic"="monument"](around:2000,${lat},${lon});
    out;`;

    const res=await fetch(OVERPASS_API,{
      method:'POST',
      headers:{'Content-Type':'application/x-www-form-urlencoded'},
      body:'data='+encodeURIComponent(query)
    });

    const data=await res.json();
    return data.elements
      .filter(e=>e.tags?.name)
      .slice(0,8)
      .map(e=>({
        name:e.tags.name,
        lat:e.lat,
        lon:e.lon
      }));
  };

  const generate=async()=>{
    const dep=MAIN_STATIONS[0];
    const arr=MAIN_STATIONS[Math.floor(Math.random()*MAIN_STATIONS.length)];

    setJourney({dep,arr});
    const p=await fetchPlaces(arr.lat,arr.lon);
    setPlaces(p);
  };

  const markers = journey ? [
    {lat:journey.dep.lat,lng:journey.dep.lon,label:journey.dep.name,color:'#00a3ff'},
    {lat:journey.arr.lat,lng:journey.arr.lon,label:journey.arr.name,color:'#00d4aa'},
    ...places.map(p=>({
      lat:p.lat,lng:p.lon,label:p.name,color:'#ff6b6b'
    }))
  ] : [];

  return (
    <div style={{height:'100%'}}>
      <button onClick={generate} style={{position:'absolute',zIndex:1000}}>
        Générer
      </button>

      <OptimizedMap
        center={[46.6,1.9]}
        zoom={6}
        markers={markers}
        polyline={journey ? [
          [journey.dep.lat,journey.dep.lon],
          [journey.arr.lat,journey.arr.lon]
        ] : null}
      />
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
