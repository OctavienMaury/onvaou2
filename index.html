<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>On va oÃ¹ ? ðŸš„</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=DM+Sans:opsz,wght@9..40,400;9..40,500;9..40,600;9..40,700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root{--bg-primary:#0a0a0f;--bg-secondary:#12121a;--bg-card:#1a1a24;--text-primary:#f5f5f7;--text-secondary:#a0a0b0;--accent:#00d4aa;--accent-glow:rgba(0,212,170,0.3);--accent-secondary:#ff6b6b;--border:rgba(255,255,255,0.08);--gradient-1:linear-gradient(135deg,#00d4aa 0%,#00a3ff 100%);--gradient-2:linear-gradient(135deg,#ff6b6b 0%,#ffa500 100%)}
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'DM Sans',sans-serif;background:var(--bg-primary);color:var(--text-primary);min-height:100vh;overflow-x:hidden}
    body::before{content:'';position:fixed;top:0;left:0;width:100%;height:100%;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");opacity:0.03;pointer-events:none;z-index:1000}
    #root{position:relative;z-index:1}
    h1,h2,h3{font-family:'Instrument Serif',serif;font-weight:400}
    .app-container{min-height:100vh;display:flex;flex-direction:column}
    .header{padding:1.5rem 2rem;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border);backdrop-filter:blur(10px);position:sticky;top:0;z-index:100;background:rgba(10,10,15,0.8)}
    .logo{display:flex;align-items:center;gap:0.75rem}
    .logo-icon{font-size:1.75rem}
    .logo-text{font-family:'Instrument Serif',serif;font-size:1.5rem;font-style:italic;background:var(--gradient-1);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .main-content{flex:1;display:flex;flex-direction:column;padding:2rem;max-width:1400px;margin:0 auto;width:100%}
    .hero{text-align:center;padding:3rem 0 4rem;position:relative}
    .hero h1{font-size:clamp(2.5rem,8vw,5rem);margin-bottom:1rem;position:relative}
    .hero p{color:var(--text-secondary);font-size:1.125rem;max-width:500px;margin:0 auto;line-height:1.6}
    .selection-panel{background:var(--bg-card);border:1px solid var(--border);border-radius:1.5rem;padding:2rem;margin-bottom:2rem;display:grid;grid-template-columns:1fr 1fr auto;gap:1.5rem;align-items:end}
    @media(max-width:768px){.selection-panel{grid-template-columns:1fr}}
    .form-group{display:flex;flex-direction:column;gap:0.5rem;position:relative}
    .form-group label{font-size:0.875rem;color:var(--text-secondary);font-weight:500;text-transform:uppercase;letter-spacing:0.05em}
    
    /* STYLE INPUT & SELECT HARMONISÃ‰ */
    .form-group input, .select-wrapper select {
      width: 100%;
      padding: 1rem;
      font-size: 1rem;
      font-family: inherit;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 0.75rem;
      color: var(--text-primary);
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .select-wrapper select { appearance: none; cursor: pointer; padding-right: 2.5rem; }
    .select-wrapper::after{content:'â–¼';position:absolute;right:1rem;top:50%;transform:translateY(-50%);color:var(--text-secondary);font-size:0.75rem;pointer-events:none}
    
    /* AUTOCOMPLETE LIST */
    .autocomplete-results {
      position: absolute;
      top: 100%; left: 0; right: 0;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 0.75rem;
      margin-top: 0.5rem;
      max-height: 250px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 0 10px 25px rgba(0,0,0,0.5);
    }
    .autocomplete-item {
      padding: 0.8rem 1rem;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.2s;
      border-bottom: 1px solid var(--border);
    }
    .autocomplete-item:last-child { border-bottom: none; }
    .autocomplete-item:hover { background: var(--bg-secondary); color: var(--accent); }

    .generate-btn{padding:1rem 2.5rem;font-size:1rem;font-family:inherit;font-weight:600;background:var(--gradient-1);border:none;border-radius:0.75rem;color:var(--bg-primary);cursor:pointer;transition:transform 0.2s,box-shadow 0.2s;white-space:nowrap}
    .generate-btn:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 10px 30px var(--accent-glow)}
    .generate-btn:disabled{opacity:0.6;cursor:not-allowed}
    .generate-btn.loading{position:relative;color:transparent}
    .generate-btn.loading::after{content:'';position:absolute;top:50%;left:50%;width:20px;height:20px;margin:-10px 0 0 -10px;border:2px solid var(--bg-primary);border-top-color:transparent;border-radius:50%;animation:spin 0.8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    
    .result-section{animation:fadeInUp 0.6s ease-out}
    @keyframes fadeInUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    .journey-header{display:flex;align-items:center;gap:1rem;margin-bottom:1.5rem;padding:1.5rem;background:var(--bg-card);border:1px solid var(--border);border-radius:1rem}
    .journey-icon{font-size:2.5rem}
    .journey-info p{color:var(--text-secondary);font-size:0.9rem}
    .journey-route{display:flex;align-items:center;gap:0.75rem;color:var(--accent)}
    .journey-route .arrow{font-size:1.25rem}
    
    .maps-grid{display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;margin-bottom:1.5rem}
    @media(max-width:900px){.maps-grid{grid-template-columns:1fr}}
    .map-card{background:var(--bg-card);border:1px solid var(--border);border-radius:1rem;overflow:hidden}
    .map-card-header{padding:1rem 1.25rem;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:0.5rem}
    .map-card-header h3{font-size:1rem;font-family:'DM Sans',sans-serif;font-weight:600}
    .map-container{height:350px;position:relative}
    
    .cultural-section{background:var(--bg-card);border:1px solid var(--border);border-radius:1rem;padding:1.5rem;margin-bottom:1.5rem}
    .cultural-section h3{font-size:1.25rem;margin-bottom:1rem;display:flex;align-items:center;gap:0.5rem}
    .places-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:1rem}
    .place-card{background:var(--bg-secondary);border:1px solid var(--border);border-radius:0.75rem;padding:1rem;display:flex;align-items:center;gap:0.75rem;transition:border-color 0.2s,transform 0.2s;text-decoration:none;color:inherit;cursor:pointer}
    .place-card:hover{border-color:var(--accent);transform:translateY(-2px)}
    .place-icon{font-size:1.5rem;flex-shrink:0}
    .place-info h4{font-size:0.9rem;font-family:'DM Sans',sans-serif;font-weight:500;margin-bottom:0.25rem}
    .place-info p{font-size:0.75rem;color:var(--text-secondary)}
    
    .booking-section{text-align:center;padding:2rem 0}
    .booking-buttons{display:flex;justify-content:center;gap:1rem;flex-wrap:wrap}
    .booking-btn{padding:0.875rem 2rem;font-size:0.9rem;font-family:inherit;font-weight:600;border:none;border-radius:0.75rem;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;gap:0.5rem;transition:transform 0.2s}
    .booking-btn.sncf{background:#000;color:#32e5fd;border:1px solid #32e5fd}
    .booking-btn.new-trip{background:var(--gradient-2);color:#fff}
    
    .loading-overlay{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:4rem;text-align:center}
    .loading-train{font-size:3rem;animation:trainMove 1.5s ease-in-out infinite}
    @keyframes trainMove{0%,100%{transform:translateX(-20px)}50%{transform:translateX(20px)}}
    .loading-text{margin-top:1rem;color:var(--text-secondary)}
    .error-message{background:rgba(255,107,107,0.1);border:1px solid var(--accent-secondary);border-radius:0.75rem;padding:1rem 1.5rem;color:var(--accent-secondary);text-align:center;margin-bottom:1rem}
    .footer{padding:2rem;text-align:center;color:var(--text-secondary);font-size:0.875rem}
  </style>
</head>
<body>
  <div id="root"></div>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const { useState, useEffect, useRef } = React;

    const API_PROXY_URL = 'https://soft-cake-00a9.kmdf29dr47.workers.dev';
    const OVERPASS_API = 'https://overpass-api.de/api/interpreter';

    const TRANSPORT_MODES = {
      'Grande vitesse (TGV, OUIGO...)': 'physical_mode:LongDistanceTrain',
      'TER (rÃ©gional)': 'physical_mode:LocalTrain',
      'IntercitÃ©s': 'physical_mode:LongDistanceTrain',
      'Tous les trains': 'all'
    };

    const PLACE_EMOJIS = { museum: 'ðŸ›ï¸', castle: 'ðŸ°', monument: 'ðŸ—¿', art_gallery: 'ðŸŽ¨', theatre: 'ðŸŽ­', default: 'â­' };
    const TYPE_LABELS = { museum: 'MusÃ©e', castle: 'ChÃ¢teau', monument: 'Monument', art_gallery: "Galerie d'art", theatre: 'ThÃ©Ã¢tre', default: "Lieu d'intÃ©rÃªt" };

    function MapView({ center, markers, polyline, mapKey }) {
      const mapRef = useRef(null);
      const instance = useRef(null);

      useEffect(() => {
        if (!mapRef.current) return;
        if (instance.current) { instance.current.remove(); instance.current = null; }

        const lat = parseFloat(center[0]);
        const lon = parseFloat(center[1]);
        if (isNaN(lat) || isNaN(lon)) return;

        instance.current = L.map(mapRef.current).setView([lat, lon], 12);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(instance.current);

        const group = L.featureGroup();
        if (markers) {
          markers.forEach(m => {
            const colorMap = { green: '#00d4aa', red: '#ff6b6b', blue: '#00a3ff' };
            const icon = L.divIcon({
              className: 'marker',
              html: `<div style="background:${colorMap[m.color]};width:18px;height:18px;border-radius:50%;border:2px solid white;box-shadow:0 2px 5px rgba(0,0,0,0.5)"></div>`,
              iconAnchor: [9, 9]
            });
            L.marker([m.lat, m.lng], { icon }).bindTooltip(m.label).addTo(group);
          });
        }
        if (polyline) L.polyline(polyline, { color: '#00d4aa', dashArray: '10, 10' }).addTo(instance.current);
        
        group.addTo(instance.current);
        if (markers && markers.length > 1) instance.current.fitBounds(group.getBounds(), { padding: [40, 40] });

        return () => { if (instance.current) instance.current.remove(); };
      }, [mapKey, markers]);

      return React.createElement('div', { ref: mapRef, style: { height: '100%', width: '100%' } });
    }

    function App() {
      const [searchInput, setSearchInput] = useState('');
      const [suggestions, setSuggestions] = useState([]);
      const [selectedStation, setSelectedStation] = useState(null);
      const [selectedMode, setSelectedMode] = useState('Grande vitesse (TGV, OUIGO...)');
      const [journey, setJourney] = useState(null);
      const [places, setPlaces] = useState([]);
      const [loading, setLoading] = useState(false);
      const [loadingPlaces, setLoadingPlaces] = useState(false);
      const [error, setError] = useState(null);

      // Logique Autocomplete
      useEffect(() => {
        const timer = setTimeout(async () => {
          if (searchInput.length > 2 && (!selectedStation || searchInput !== selectedStation.name)) {
            try {
              const res = await fetch(`${API_PROXY_URL}/search?q=${encodeURIComponent(searchInput)}`);
              const data = await res.json();
              const gares = (data.places || []).filter(p => p.embedded_type === "stop_area");
              setSuggestions(gares);
            } catch (e) { console.error(e); }
          } else { setSuggestions([]); }
        }, 300);
        return () => clearTimeout(timer);
      }, [searchInput, selectedStation]);

      const fetchPlaces = async (lat, lon, city) => {
        setLoadingPlaces(true);
        const query = `[out:json][timeout:25];(node["tourism"~"museum|art_gallery"](around:3000,${lat},${lon});way["historic"~"castle|monument"](around:5000,${lat},${lon});node["amenity"="theatre"](around:1000,${lat},${lon}););out center tags;`;
        try {
          const res = await fetch(OVERPASS_API, { method: 'POST', body: 'data=' + encodeURIComponent(query) });
          const data = await res.json();
          const results = data.elements.map(el => {
            const tags = el.tags;
            const type = tags.tourism === 'museum' ? 'museum' : tags.historic === 'castle' ? 'castle' : tags.amenity === 'theatre' ? 'theatre' : tags.tourism === 'art_gallery' ? 'art_gallery' : 'default';
            return {
              name: tags.name,
              type: type,
              lat: el.lat || el.center.lat,
              lng: el.lon || el.center.lon,
              url: tags.website || `https://www.google.com/search?q=${encodeURIComponent(tags.name + ' ' + city)}`
            };
          }).filter(p => p.name).slice(0, 12);
          setPlaces(results);
        } catch (e) { console.error(e); }
        setLoadingPlaces(false);
      };

      const generate = async () => {
        if (!selectedStation) { setError("Veuillez choisir une gare dans la liste"); return; }
        setLoading(true); setError(null); setJourney(null);
        try {
          let depUrl = `${API_PROXY_URL}/departures/${encodeURIComponent(selectedStation.id)}`;
          if (selectedMode !== 'Tous les trains') depUrl += `?mode=${TRANSPORT_MODES[selectedMode]}`;

          const dRes = await fetch(depUrl);
          const dData = await dRes.json();
          let dests = dData.destinations || [];

          if (selectedMode.includes('Grande vitesse')) {
            dests = dests.filter(d => /TGV|OUIGO|ICE|INOUÃ|EUROSTAR/i.test(d.line) && !/TER|ZOU|RER|BUS|TRANSILIEN/i.test(d.line));
          }

          if (dests.length === 0) throw new Error("Aucun train trouvÃ© pour cette sÃ©lection.");

          const choice = dests[Math.floor(Math.random() * dests.length)];
          const newJourney = {
            from: { name: selectedStation.name, lat: selectedStation.stop_area.coord.lat, lng: selectedStation.stop_area.coord.lon },
            to: { name: choice.name, lat: choice.coord.lat, lng: choice.coord.lon },
            line: choice.line
          };
          setJourney(newJourney);
          fetchPlaces(choice.coord.lat, choice.coord.lon, choice.name);
        } catch (e) { setError(e.message); }
        setLoading(false);
      };

      const h = React.createElement;

      return h('div', { className: 'app-container' },
        h('header', { className: 'header' },
          h('div', { className: 'logo' }, h('span', { className: 'logo-icon' }, 'ðŸš„'), h('span', { className: 'logo-text' }, 'On va oÃ¹ ?'))
        ),
        h('main', { className: 'main-content' },
          h('section', { className: 'hero' }, h('h1', null, 'OÃ¹ va-t-on ?'), h('p', null, 'Le hasard guide votre prochain voyage.')),
          h('div', { className: 'selection-panel' },
            h('div', { className: 'form-group' }, 
              h('label', null, 'Gare de dÃ©part'),
              h('input', { 
                type: 'text', 
                value: searchInput, 
                placeholder: 'Chercher une ville...', 
                onChange: e => setSearchInput(e.target.value) 
              }),
              suggestions.length > 0 && h('div', { className: 'autocomplete-results' },
                suggestions.map(s => h('div', { 
                  key: s.id, 
                  className: 'autocomplete-item', 
                  onClick: () => { setSelectedStation(s); setSearchInput(s.name); setSuggestions([]); } 
                }, s.name))
              )
            ),
            h('div', { className: 'form-group' }, h('label', null, 'Type'), h('div', { className: 'select-wrapper' },
              h('select', { value: selectedMode, onChange: e => setSelectedMode(e.target.value) },
                Object.keys(TRANSPORT_MODES).map(m => h('option', { key: m, value: m }, m))
              )
            )),
            h('button', { className: `generate-btn ${loading ? 'loading' : ''}`, onClick: generate, disabled: loading || !selectedStation }, loading ? '' : 'ðŸŽ² GÃ©nÃ©rer')
          ),
          error && h('div', { className: 'error-message' }, error),
          loading && h('div', { className: 'loading-overlay' }, h('div', { className: 'loading-train' }, 'ðŸš„'), h('p', null, 'Recherche...')),
          
          journey && h('div', { className: 'result-section' },
            h('div', { className: 'journey-header' }, h('span', { className: 'journey-icon' }, 'ðŸš‚'),
              h('div', { className: 'journey-info' },
                h('div', { className: 'journey-route' }, h('span', null, journey.from.name), h('span', { className: 'arrow' }, 'â†’'), h('span', null, journey.to.name)),
                h('p', null, `Via ${journey.line}`)
              )
            ),
            h('div', { className: 'maps-grid' },
              h('div', { className: 'map-card' }, h('div', { className: 'map-card-header' }, h('span', null, 'ðŸ—ºï¸'), h('h3', null, 'ItinÃ©raire')),
                h('div', { className: 'map-container' }, h(MapView, {
                  mapKey: 'j-' + journey.to.name, center: [46.6, 2.2],
                  markers: [{ ...journey.from, color: 'blue', label: journey.from.name }, { ...journey.to, color: 'green', label: journey.to.name }],
                  polyline: [[journey.from.lat, journey.from.lng], [journey.to.lat, journey.to.lng]]
                }))
              ),
              h('div', { className: 'map-card' }, h('div', { className: 'map-card-header' }, h('span', null, 'ðŸ“'), h('h3', null, `Autour de ${journey.to.name}`)),
                h('div', { className: 'map-container' }, h(MapView, {
                  mapKey: 'p-' + journey.to.name, center: [journey.to.lat, journey.to.lng],
                  markers: [{ ...journey.to, color: 'green', label: 'Gare' }, ...places.map(p => ({ ...p, color: 'red', label: p.name }))]
                }))
              )
            ),
            h('div', { className: 'cultural-section' }, h('h3', null, 'ðŸ›ï¸ Lieux culturels'),
              loadingPlaces ? h('div', { className: 'places-loading' }, 'Chargement...') :
              places.length > 0 ? h('div', { className: 'places-grid' },
                places.map((p, i) => h('a', { key: i, href: p.url, target: '_blank', className: 'place-card' },
                  h('span', { className: 'place-icon' }, PLACE_EMOJIS[p.type] || PLACE_EMOJIS.default),
                  h('div', { className: 'place-info' }, h('h4', null, p.name), h('p', null, TYPE_LABELS[p.type] || TYPE_LABELS.default))
                ))
              ) : h('p', { className: 'no-places' }, 'Aucun lieu trouvÃ©')
            ),
            h('div', { className: 'booking-section' }, h('div', { className: 'booking-buttons' },
              h('a', { className: 'booking-btn sncf', href: `https://www.sncf-connect.com/app/home/search?originLabel=${encodeURIComponent(journey.from.name)}&destinationLabel=${encodeURIComponent(journey.to.name)}`, target: '_blank' }, 'SNCF Connect'),
              h('button', { className: 'booking-btn new-trip', onClick: generate }, 'ðŸŽ² Relancer')
            ))
          )
        ),
        h('footer', { className: 'footer' }, h('p', null, 'DonnÃ©es SNCF & OpenStreetMap'))
      );
    }

    ReactDOM.createRoot(document.getElementById('root'))
  .render(React.createElement(App));
  </script>
</body>
</html>
